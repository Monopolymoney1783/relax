#!/usr/bin/env bash -eu
# @(#) relax: `package` command
# completions

usage() {
	cat <<-EOM
	usage: ${ME} package <dist> <package_path>
	EOM
	fin
}

make_package() {
	[[ $# == 2 ]] || usage

	local dist=$1
	local package_dir=$2

	[[ " ${REL_DISTRIBUTIONS[@]} " =~ " $dist "  ]]  || die "Not found '$dist' dist"

	### Make artifacts

	logi "$ARROW Clean up $package_dir"

	rm -rf "$package_dir" > /dev/null 2>&1
	mkdir -p "$package_dir" > /dev/null 2>&1

	local ipa_path="$(read_path $dist ipa)"
	[[ -f "$ipa_path" ]] || die "Not found '$dist' ipa"

	cp "$ipa_path" "$package_dir"

	local archive="$(read_path $dist archive)"
	[[ -d "$archive" ]] || die "Not found '$dist' archive"

	zipname="$(basename "$archive")".zip

	logi "$ARROW Install ipa and xcarchive"
	logi "Package Directory: $HERE/$package_dir"

	ditto -c -k --sequesterRsrc --keepParent "$archive" "$package_dir/$zipname"

	ls "$package_dir"
}


[[ $# != 0 ]] || usage

arg=$1
shift
case $arg in
-h|--help) 
	usage 
	;;
--completions)
	if [[ $# == 0 ]]; then
		echo "${REL_DISTRIBUTIONS[@]}"
	else
		:
	fi
	fin
	;;
*)
	;;
esac

make_package "$arg" "$@"
